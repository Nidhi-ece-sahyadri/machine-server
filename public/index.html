<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Machine Health Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background: #222; color: #fff; padding: 20px; }
        .card { background: #333; padding: 15px; margin: 10px; border-radius: 8px; display: inline-block; width: 220px; vertical-align: top; }
        .metric { font-size: 1.1em; }
        #status { font-weight: bold; font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>Machine Health Dashboard</h1>

    <div class="card"><p class="metric">Status: <span id="status">--</span></p></div>
    <div class="card"><p class="metric">Health Index: <span id="hi">--</span>%</p></div>
    <div class="card"><p class="metric">Vibration Score: <span id="vibScore">--</span>%</p></div>
    <div class="card"><p class="metric">Temperature Score: <span id="tempScore">--</span>%</p></div>
    <div class="card"><p class="metric">Electrical Score: <span id="elecScore">--</span>%</p></div>
    <div class="card"><p class="metric">RPM Score: <span id="rpmScore">--</span>%</p></div>
    <div class="card"><p class="metric">Correlation Score: <span id="corrScore">--</span>%</p></div>

    <div class="card"><p class="metric">Temp Prev: <span id="tempPrev">--</span> °C</p></div>
    <div class="card"><p class="metric">Temp Rise 60s: <span id="tempRise">--</span> °C</p></div>
    <div class="card"><p class="metric">Voltage RMS: <span id="Vrms">--</span> V</p></div>
    <div class="card"><p class="metric">Current RMS: <span id="Irms">--</span> A</p></div>
    <div class="card"><p class="metric">Peak: <span id="peak">--</span></p></div>
    <div class="card"><p class="metric">DTCs: <span id="dtcs">--</span></p></div>

    <script>
        async function fetchCSV() {
            try {
                const res = await fetch('/latest-data');
                if (!res.ok) return;
                const text = await res.text();
                const lines = text.trim().split('\n');
                const headers = lines[0].split(',');
                const lastLine = lines[lines.length - 1].split(',');

                // Update metrics
                document.getElementById("hi").textContent = parseFloat(lastLine[headers.indexOf("HealthIndex")]).toFixed(2);
                document.getElementById("vibScore").textContent = parseFloat(lastLine[headers.indexOf("vibScore")]).toFixed(2);
                document.getElementById("tempScore").textContent = parseFloat(lastLine[headers.indexOf("tempScore")]).toFixed(2);
                document.getElementById("elecScore").textContent = parseFloat(lastLine[headers.indexOf("elecScore")]).toFixed(2);
                document.getElementById("rpmScore").textContent = parseFloat(lastLine[headers.indexOf("rpmScore")]).toFixed(2);
                document.getElementById("corrScore").textContent = parseFloat(lastLine[headers.indexOf("corrScore")]).toFixed(2);
                document.getElementById("tempPrev").textContent = parseFloat(lastLine[headers.indexOf("TempPrev")]).toFixed(2);
                document.getElementById("tempRise").textContent = parseFloat(lastLine[headers.indexOf("TempRise60s")]).toFixed(2);
                document.getElementById("Vrms").textContent = parseFloat(lastLine[headers.indexOf("Vrms")]).toFixed(2);
                document.getElementById("Irms").textContent = parseFloat(lastLine[headers.indexOf("Irms")]).toFixed(3);
                document.getElementById("peak").textContent = parseFloat(lastLine[headers.indexOf("Peak")]).toFixed(3);
                document.getElementById("dtcs").textContent = lastLine[headers.indexOf("DTCs")];

                // Status color (case-insensitive)
                const status = lastLine[headers.indexOf("Status")];
                const statusEl = document.getElementById("status");
                statusEl.textContent = status;

                switch(status.toUpperCase()) {
                    case "HEALTHY":
                        statusEl.style.color = "lime";
                        break;
                    case "WARNING":
                        statusEl.style.color = "yellow";
                        break;
                    case "FAULTY":
                        statusEl.style.color = "red";
                        break;
                    default:
                        statusEl.style.color = "white";
                        break;
                }

            } catch (err) {
                console.error(err);
            }
        }

        // Poll every 5 seconds
        setInterval(fetchCSV, 5000);
        fetchCSV();
    </script>
</body>
</html>
